<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ПриватБанк Транспорт</title>
    
    <!-- PWA -->
    <link rel="manifest" href="../manifest.json">
    <meta name="theme-color" content="#8bc34a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Транспорт">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        #app-frame {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }
        
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-family: 'Roboto', sans-serif;
            z-index: 9999;
            opacity: 1;
            visibility: visible;
            transition: opacity 0.2s, visibility 0s;
        }
        
        .loading.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.2s, visibility 0s 0.2s;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">Завантаження...</div>
    <iframe id="app-frame" src="about:blank"></iframe>

    <script>
        const SPA = {
            frame: null,
            loading: null,
            currentPage: null,
            
            pages: {
                'transport': '../transport.html',
                'index': '../index.html',
                'qr': '../qr.html',
                'payment': '../payment.html',
                'settings': '../settings.html'
            },
            
            init() {
                this.frame = document.getElementById('app-frame');
                this.loading = document.getElementById('loading');
                
                // Слухаємо зміни hash
                window.addEventListener('hashchange', () => this.onHashChange());
                
                // Слухаємо повідомлення від iframe для навігації
                window.addEventListener('message', (e) => this.onMessage(e));
                
                // Коли iframe завантажився
                this.frame.addEventListener('load', () => this.onFrameLoad());
                
                // Початкова сторінка
                const hash = window.location.hash.slice(1) || 'transport';
                this.navigate(hash);
            },
            
            navigate(page) {
                if (!this.pages[page]) {
                    page = 'transport';
                }
                
                if (this.currentPage === page) return;
                
                this.showLoading();
                window.location.hash = page;
                this.frame.src = this.pages[page];
                this.currentPage = page;
            },
            
            onHashChange() {
                const hash = window.location.hash.slice(1) || 'transport';
                if (hash !== this.currentPage) {
                    this.navigate(hash);
                }
            },
            
            onFrameLoad() {
                this.hideLoading();
                this.injectNavigationOverride();
            },
            
            onMessage(e) {
                if (e.data && e.data.type === 'navigate') {
                    this.navigate(e.data.page);
                }
            },
            
            injectNavigationOverride() {
                try {
                    const frameDoc = this.frame.contentDocument || this.frame.contentWindow.document;
                    const frameWin = this.frame.contentWindow;
                    
                    // Перехоплюємо ВСІ кліки (включаючи inline onclick)
                    frameDoc.addEventListener('click', (e) => {
                        const link = e.target.closest('a[href], button[onclick], .icon-btn[onclick]');
                        if (link) {
                            const href = link.getAttribute('href') || '';
                            const onclick = link.getAttribute('onclick') || '';
                            
                            let page = null;
                            
                            // Перевірка href
                            if (href.includes('transport.html')) page = 'transport';
                            else if (href.includes('index.html')) page = 'index';
                            else if (href.includes('qr.html')) page = 'qr';
                            else if (href.includes('payment.html')) page = 'payment';
                            else if (href.includes('settings.html')) page = 'settings';
                            
                            // Перевірка onclick
                            if (!page && onclick) {
                                if (onclick.includes('transport.html') || onclick.includes("transport.html")) page = 'transport';
                                else if (onclick.includes('index.html') || onclick.includes("index.html")) page = 'index';
                                else if (onclick.includes('qr.html') || onclick.includes("qr.html")) page = 'qr';
                                else if (onclick.includes('payment.html') || onclick.includes("payment.html")) page = 'payment';
                                else if (onclick.includes('settings.html') || onclick.includes("settings.html")) page = 'settings';
                            }
                            
                            if (page) {
                                e.preventDefault();
                                e.stopPropagation();
                                e.stopImmediatePropagation();
                                
                                // Зупинити камеру якщо це QR сторінка
                                if (frameWin.stopQRCamera) {
                                    frameWin.stopQRCamera();
                                }
                                
                                window.parent.postMessage({ type: 'navigate', page: page }, '*');
                                return false;
                            }
                        }
                    }, true);
                    
                    // Перехоплюємо window.location зміни
                    const originalLocationDescriptor = Object.getOwnPropertyDescriptor(frameWin, 'location');
                    
                    // Перевизначаємо goToPage якщо існує
                    if (frameWin.goToPage) {
                        const originalGoToPage = frameWin.goToPage;
                        frameWin.goToPage = function(page) {
                            window.parent.postMessage({ type: 'navigate', page: page }, '*');
                        };
                    }
                    
                    // Перехоплюємо пряме присвоєння location.href
                    const locationProxy = new Proxy({}, {
                        set: (target, prop, value) => {
                            if (prop === 'href') {
                                let page = null;
                                if (value.includes('transport.html')) page = 'transport';
                                else if (value.includes('index.html')) page = 'index';
                                else if (value.includes('qr.html')) page = 'qr';
                                else if (value.includes('payment.html')) page = 'payment';
                                else if (value.includes('settings.html')) page = 'settings';
                                
                                if (page) {
                                    window.parent.postMessage({ type: 'navigate', page: page }, '*');
                                    return true;
                                }
                            }
                            return Reflect.set(frameWin.location, prop, value);
                        },
                        get: (target, prop) => {
                            const value = frameWin.location[prop];
                            if (typeof value === 'function') {
                                return value.bind(frameWin.location);
                            }
                            return value;
                        }
                    });
                    
                } catch (err) {
                    console.log('Cannot inject navigation override:', err);
                }
            },
            
            showLoading() {
                this.loading.classList.remove('hidden');
            },
            
            hideLoading() {
                this.loading.classList.add('hidden');
            }
        };
        
        // Ініціалізація
        document.addEventListener('DOMContentLoaded', () => SPA.init());
        
        // Реєстрація Service Worker для PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('../service-worker.js')
                .then((reg) => console.log('SW registered'))
                .catch((err) => console.log('SW failed:', err));
        }
    </script>
</body>
</html>
