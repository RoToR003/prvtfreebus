<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Сканування коду</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: #000;
            color: #fff;
            height: 100vh;
            width: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* --- ВІДЕО --- */
        #camera-stream {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }

        .camera-fallback {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, #777 0%, #444 100%);
            z-index: 0;
            display: none;
        }
        
        .camera-fallback.active {
            display: block;
        }

        /* --- ІНТЕРФЕЙС --- */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
        }

        /* --- ВЕРХНЯ ПАНЕЛЬ --- */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px; 
            padding: 0 4px;
        }

        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .page-title {
            font-size: 20px;
            font-weight: 400;
            color: #fff;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
        }

        /* --- РАМКА СКАНУВАННЯ --- */
        .scan-frame-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding-bottom: 0; 
        }

        .scan-frame {
            width: 250px;
            height: 250px;
            position: relative;
        }

        .corner {
            position: absolute;
            /* [ЗМІНЕНО] Довжина рамок зменшена до 25px (було 40px) */
            width: 25px;
            height: 25px;
            border-color: #fff;
            border-style: solid;
            border-width: 0;
            opacity: 1;
        }

        /* Жирність кутів 6px збережена */
        .top-left {
            top: 0;
            left: 0;
            border-top-width: 6px;
            border-left-width: 6px;
        }

        .top-right {
            top: 0;
            right: 0;
            border-top-width: 6px;
            border-right-width: 6px;
        }

        .bottom-left {
            bottom: 0;
            left: 0;
            border-bottom-width: 6px;
            border-left-width: 6px;
        }

        .bottom-right {
            bottom: 0;
            right: 0;
            border-bottom-width: 6px;
            border-right-width: 6px;
        }

        /* --- НИЖНЯ ПАНЕЛЬ --- */
        .bottom-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 90px; 
        }

        .buttons-row {
            display: flex;
            width: 100%;
            justify-content: space-between;
            padding: 0 60px; 
            margin-bottom: 20px; 
        }

        /* Кнопки */
        .circle-btn {
            width: 48px;
            height: 48px;
            background-color: #ffffff; 
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
        }

        /* [ЗМІНЕНО] Іконки: ефект повного вирізу (прозорості) */
        .bottom-controls .circle-btn svg {
            fill: #000000;
            /* Ця властивість "вирізає" іконку з білої кнопки, роблячи її прозорою */
            mix-blend-mode: destination-out; 
            transform: scaleX(-1);
        }

        .instruction-text {
            color: #e0e0e0;
            text-align: center;
            font-size: 15px;
            line-height: 1.4;
            max-width: 300px;
            /* [ЗМІНЕНО] Текст опущено ще на 10px (було 25px -> стало 35px) */
            margin-top: 35px; 
        }

    </style>
</head>
<body>

    <video id="camera-stream" autoplay playsinline muted></video>
    <div id="camera-fallback" class="camera-fallback"></div>

    <div class="overlay">
        <div class="top-bar">
            <button class="icon-btn" onclick="window.location.href='index.html'">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 6L6 18" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M6 6L18 18" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            
            <div class="page-title">Сканування коду</div>
            
            <button class="icon-btn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 19V5C21 3.9 20.1 3 19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19ZM8.5 13.5L11 16.51L14.5 12L19 18H5L8.5 13.5Z" fill="white"/>
                </svg>
            </button>
        </div>

        <div class="scan-frame-container">
            <div class="scan-frame">
                <div class="corner top-left"></div>
                <div class="corner top-right"></div>
                <div class="corner bottom-left"></div>
                <div class="corner bottom-right"></div>
            </div>
        </div>

        <div class="bottom-controls">
            <div class="buttons-row">
                <button class="circle-btn" onclick="goToPayment()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M7 2V13H10V22L17 10H13L13 2H7ZM17.59 5.41L15.47 3.29L3.29 15.47L5.41 17.59L17.59 5.41Z"/>
                    </svg>
                </button>
                
                <button class="circle-btn" onclick="switchCamera()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 4V1L8 5L12 9V6C15.31 6 18 8.69 18 12C18 13.01 17.75 13.97 17.3 14.8L18.76 16.26C19.54 15.03 20 13.57 20 12C20 7.58 16.42 4 12 4ZM12 18C8.69 18 6 15.31 6 12C6 10.99 6.25 10.03 6.7 9.2L5.24 7.74C4.46 8.97 4 10.43 4 12C4 16.42 7.58 20 12 20V23L16 19L12 15V18Z"/>
                    </svg>
                </button>
            </div>
            
            <div class="instruction-text">
                Щоб відсканувати QR-код, тримайте пристрій так, щоб код був у рамці
            </div>
        </div>
    </div>

    <script>
        const videoElement = document.getElementById('camera-stream');
        const fallbackElement = document.getElementById('camera-fallback');
        let currentFacingMode = 'environment';
        let currentDeviceId = null;

        async function startCamera() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                try {
                    // Отримуємо налаштування камери з localStorage
                    const savedDeviceId = localStorage.getItem('selected_camera_id');
                    
                    // Налаштування для максимальної якості
                    const constraints = {
                        video: {
                            facingMode: currentFacingMode,
                            width: { ideal: 4096 },
                            height: { ideal: 2160 },
                            aspectRatio: { ideal: 16/9 },
                            frameRate: { ideal: 60, min: 30 }
                        }
                    };
                    
                    // Якщо є збережений deviceId, використовуємо його
                    if (savedDeviceId && currentDeviceId === null) {
                        constraints.video.deviceId = { exact: savedDeviceId };
                        delete constraints.video.facingMode;
                    } else if (currentDeviceId) {
                        constraints.video.deviceId = { exact: currentDeviceId };
                        delete constraints.video.facingMode;
                    }
                    
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    videoElement.srcObject = stream;
                    fallbackElement.classList.remove('active');
                    
                    // Зберігаємо поточний deviceId
                    const videoTrack = stream.getVideoTracks()[0];
                    if (videoTrack) {
                        currentDeviceId = videoTrack.getSettings().deviceId;
                    }
                } catch (error) {
                    console.error("Помилка:", error);
                    // Якщо не вдалося з високою якістю, пробуємо базові налаштування
                    try {
                        const basicConstraints = {
                            video: { facingMode: currentFacingMode }
                        };
                        const stream = await navigator.mediaDevices.getUserMedia(basicConstraints);
                        videoElement.srcObject = stream;
                        fallbackElement.classList.remove('active');
                    } catch (fallbackError) {
                        console.error("Базова помилка:", fallbackError);
                        showFallback();
                    }
                }
            } else {
                showFallback();
            }
        }

        function showFallback() {
            videoElement.style.display = 'none';
            fallbackElement.classList.add('active');
        }

        function switchCamera() {
            currentFacingMode = (currentFacingMode === 'environment') ? 'user' : 'environment';
            currentDeviceId = null; // Скидаємо deviceId при перемиканні
            if (videoElement.srcObject) {
                videoElement.srcObject.getTracks().forEach(track => track.stop());
            }
            startCamera();
        }

        function goToPayment() {
            // Зберегти мітку про сканування
            sessionStorage.setItem('qr_scanned', 'true');
            // Перейти на сторінку оплати
            window.location.href = 'payment.html';
        }

        window.addEventListener('load', startCamera);
    </script>
    <script src="index.js"></script>
</body>
</html>
